rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Check if a user is an Admin by looking in a separate 'adminUsers' collection
    function isAdmin() {
      return exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid));
    }

    // Users Collection
    match /users/{uid} {
      // A new user (via the Cloud Function) can be created.
      // A user can update their OWN profile (e.g., to add their name later)
      allow create, update: if request.auth.uid == uid;
      // Only Admins can see the full user list (for the User Management page)
      // and a user can see their own profile
      allow get: if request.auth.uid == uid || isAdmin();
      allow list: if isAdmin();
      allow delete: if isAdmin();
    }

    // AdminUsers Collection (The "Admin List")
    match /adminUsers/{uid} {
      // Only other Admins can read or write to the admin list
      allow read, write, delete: if isAdmin();
    }

    // Workspaces Collection (The "Settings")
    match /workspaces/{docId=**} {
      // Any logged-in user (i.e., everyone) can READ the settings (for dropdowns)
      allow read: if request.auth != null;
      // Only Admins can WRITE to the settings
      allow write: if isAdmin();
    }

    // Projects Collection (The "Data")
    match /projects/{projectId} {
      // A user can create a project IF they are the owner
      allow create: if request.auth.uid == request.resource.data.ownerId;
      // A user can read, update, or delete a project IF they are the owner
      allow read, update, delete: if request.auth.uid == resource.data.ownerId;
      // An admin can read or list projects
      allow list, get: if isAdmin();


      // Project Sub-collections (laborItems, materialItems, etc.)
      match /{subCollection}/{docId} {
        // A user can read/write items in a project IF they own the parent project
        // Or if they are an admin
        allow read, write: if request.auth.uid == get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId || isAdmin();
      }
    }
  }
}
